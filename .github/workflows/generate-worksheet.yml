name: Generate Worksheet

on:
  schedule:
    - cron: "0 20 */2 * *"
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: Wake Railway service
        run: |
          echo "Waking service via root endpoint..."
          curl --silent "${{ secrets.API_BASE_URL }}/" || true
          sleep 8

      - name: Request token with retries
        id: get_token
        run: |
          MAX_RETRIES=4
          RETRY_DELAY=15

          for i in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $i to obtain token..."

            RESPONSE=$(curl --silent -X POST "${{ secrets.API_BASE_URL }}/api/token/" \
              -H "Content-Type: application/json" \
              -d "{\"username\": \"${{ secrets.API_USERNAME }}\", \"password\": \"${{ secrets.API_PASSWORD }}\"}")

            TOKEN=$(echo "$RESPONSE" | python3 -c "
import sys, json
try:
    data = json.loads(sys.stdin.read())
    print(data.get('token', '').strip())
except Exception:
    pass
")

            if [ -n "$TOKEN" ]; then
              echo "Token acquired."
              echo "::add-mask::$TOKEN"
              printf "token=%s\n" "$TOKEN" >> "$GITHUB_OUTPUT"
              exit 0
            fi

            echo "No token yet. Retrying in $RETRY_DELAY seconds..."
            sleep $RETRY_DELAY
          done

          echo "Failed to obtain token after $MAX_RETRIES attempts."
          exit 1

      - name: Call generate worksheet endpoint
        run: |
          curl --fail --show-error -X POST \
            "${{ secrets.API_BASE_URL }}/api/worksheet/generate-worksheet/" \
            -H "Authorization: Token ${{ steps.get_token.outputs.token }}"