name: Generate Worksheet

on:
  schedule:
    - cron: "0 14 */2 * *"
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: Wake Railway service
        run: |
          echo "Waiting for service to be ready..."
          for i in $(seq 1 24); do
            STATUS=$(curl --silent -o /dev/null -w "%{http_code}" "${{ secrets.API_BASE_URL }}/")
            if [ "$STATUS" -eq 200 ] || [ "$STATUS" -eq 401 ] || [ "$STATUS" -eq 403 ]; then
              echo "Service is up (HTTP $STATUS)"
              break
            fi
            echo "Attempt $i: got $STATUS, waiting..."
            sleep 5
          done

      - name: Request token with retries
        id: get_token
        run: |
          MAX_RETRIES=4
          RETRY_DELAY=15

          for i in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $i to obtain token..."

            RESPONSE=$(curl --silent -X POST "${{ secrets.API_BASE_URL }}/api/token/" \
              -H "Content-Type: application/json" \
              -d "{\"username\": \"${{ secrets.API_USERNAME }}\", \"password\": \"${{ secrets.API_PASSWORD }}\"}")

            TOKEN=$(echo "$RESPONSE" | jq -r '.token // empty' | tr -d '\n\r')

            if [ -n "$TOKEN" ]; then
              echo "Token acquired."
              echo "::add-mask::$TOKEN"
              echo "token=$TOKEN" >> "$GITHUB_OUTPUT"
              exit 0
            fi

            echo "No token yet. Retrying in $RETRY_DELAY seconds..."
            sleep $RETRY_DELAY
          done

          echo "Failed to obtain token after $MAX_RETRIES attempts."
          exit 1

      - name: Call generate worksheet endpoint
        run: |
          TOKEN="${{ steps.get_token.outputs.token }}"
          if [ -z "$TOKEN" ]; then
            echo "ERROR: Token is empty!"
            exit 1
          fi
          echo "Calling generate worksheet endpoint..."
          curl --fail --show-error -X POST \
            "${{ secrets.API_BASE_URL }}/api/worksheet/generate-worksheet/" \
            -H "Authorization: Token $TOKEN"