name: Generate Worksheet

on:
  schedule:
    - cron: "0 20 */2 * *"
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: Request Token with retries (handles Railway wake-up)
        id: get_token
        run: |
          MAX_RETRIES=3
          RETRY_DELAY=12

          for i in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $i to obtain token..."

            RESPONSE=$(curl -s -X POST "${{ secrets.API_BASE_URL }}/api/token/" \
              -H "Content-Type: application/json" \
              -d "{\"username\": \"${{ secrets.API_USERNAME }}\", \"password\": \"${{ secrets.API_PASSWORD }}\"}")

            TOKEN=$(echo "$RESPONSE" | python3 -c "
          import sys, json
          try:
              data = json.loads(sys.stdin.read())
              print(data.get('token', ''))
          except:
              print('')
          ")

            if [ -n "$TOKEN" ]; then
              echo "Token acquired."
              echo "::add-mask::$TOKEN"
              echo "token=$TOKEN" >> $GITHUB_OUTPUT
              exit 0
            fi

            echo "No token received. Server may be waking up."
            echo "Retrying in $RETRY_DELAY seconds..."
            sleep $RETRY_DELAY
          done

          echo "Failed to obtain token after $MAX_RETRIES attempts."
          exit 1

      - name: Call generate worksheet endpoint
        run: |
          curl --silent --show-error -X POST "${{ secrets.API_BASE_URL }}/api/worksheet/generate-worksheet/" \
            -H "Authorization: Token ${{ steps.get_token.outputs.token }}"